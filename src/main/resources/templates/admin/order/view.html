<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="admin/fragments/head :: head">
	<!-- Ti√™u ƒë·ªÅ n√†y s·∫Ω ƒë∆∞·ª£c truy·ªÅn v√†o fragment 'head' -->
</head>

<body>
	<div class="wrapper">
		<!-- Sidebar -->
		<div th:replace="admin/fragments/sidebar :: sidebar"></div>
		<!-- End Sidebar -->

		<div class="main-panel">
			<!-- Header -->
			<div th:replace="~{admin/fragments/header :: header}"></div>
			<!-- End Header -->

			<div class="container" style="background-color: #faeee7; padding: 20px; border-radius: 8px;">
				<div class="page-inner">
					<div class="d-flex justify-content-between align-items-center mb-4">
						<div>
							<h3 class="fw-bold mb-3">Chi Ti·∫øt ƒê∆°n H√†ng</h3>
							<h6 class="text-dark">Th√¥ng tin chi ti·∫øt cho ƒë∆°n h√†ng</h6>
						</div>
					</div>
					<!-- N√∫t Quay l·∫°i -->
					<!-- N√∫t ƒëi·ªÅu h∆∞·ªõng -->
					<div class="mt-4 d-flex gap-3">
						<a th:href="@{/admin/orders}" class="btn btn-outline-dark px-4">üîô Quay L·∫°i</a>
						<div th:if="${donHang.trangThaiDonHang == 'ƒê√£ ho√†n th√†nh'}">
							<a th:href="@{/admin/hoadon/{maDonHang}(maDonHang=${donHang.maDonHang})}"
								class="btn btn-primary px-4">üìú Xem H√≥a ƒê∆°n</a>
						</div>


					</div>

					<!-- Th√¥ng tin ƒë∆°n h√†ng -->
					<div th:if="${error}" class="alert alert-danger" role="alert">
						<span th:text="${error}"></span>
					</div>

					<div class="row">
						<!-- Th√¥ng Tin ƒê∆°n H√†ng -->



						<div class="container">
							<!-- Th√¥ng Tin ƒê∆°n H√†ng -->
							<div class="card shadow-sm">
								<div class="card-header bg-dark">
									<h5 class="mb-0 text-light">Th√¥ng Tin ƒê∆°n H√†ng</h5>
								</div>
								<div class="card-body">
									<table class="table table-bordered">
										<tbody>
											<tr>
												<th>M√£ ƒê∆°n H√†ng</th>
												<td th:text="${donHang.maDonHang}"></td>
												<th>ƒê·ªãa Ch·ªâ Giao H√†ng</th>
												<td th:text="${donHang.diaChiGiaoHang}"></td>
											</tr>
											<tr>
												<th>Kh√°ch H√†ng</th>
												<td th:text="${donHang.nguoiDung.tenNguoiDung}"></td>
												<th>S·ªë ƒêi·ªán Tho·∫°i Nh·∫≠n H√†ng</th>
												<td th:if="${donHang.nguoiDung.tenNguoiDung != 'Kh√°ch v√£ng lai'}"
													th:text="${donHang.sdtNhanHang}"></td>
												<td th:if="${donHang.nguoiDung.tenNguoiDung == 'Kh√°ch v√£ng lai'}"></td>

											</tr>

											<tr>
												<th>Ng√†y ƒê·∫∑t</th>
												<td th:text="${#temporals.format(donHang.ngayDat, 'dd/MM/yyyy HH:mm')}">
												</td>
												<th>Tr·∫°ng Th√°i
													<th:block
														th:if="${donHang.trangThaiChoXacNhan != null and not #strings.isEmpty(donHang.trangThaiChoXacNhan)}">
														<span
															style="color: #e67e22; font-weight: bold; font-size: 11px;">(Ch·ªù
															x√°c nh·∫≠n:
															<span th:text="${donHang.trangThaiChoXacNhan}"></span>)
														</span>
													</th:block>

												</th>


												<td th:text="${donHang.trangThaiDonHang}" th:styleappend="${
											        donHang.trangThaiDonHang == 'ƒê√£ ho√†n th√†nh' ? 'color: #28a745; font-weight: bold;' :
											        donHang.trangThaiDonHang == 'ƒêang giao h√†ng' ? 'color: #17a2b8; font-weight: bold;' :
											        donHang.trangThaiDonHang == 'Giao th·∫•t b·∫°i' ? 'color: #dc3545; font-weight: bold;' :
											        donHang.trangThaiDonHang == 'ƒê√£ h·ªßy' ? 'color: #dc3545; font-weight: bold;' :
											        donHang.trangThaiDonHang == 'ƒêang x·ª≠ l√Ω' ? 'color: #ffc107; font-weight: bold;' :
											        donHang.trangThaiDonHang == 'ƒê√£ x√°c nh·∫≠n' ? 'color: #ff9800; font-weight: bold;' : 
											        ''}">


												</td>

												<!-- Hi·ªÉn th·ªã tr·∫°ng th√°i c·∫ßn x√°c nh·∫≠n ngay b√™n c·∫°nh -->




											</tr>

										</tbody>
									</table>
									<div class="text-center mt-3">

										<!-- ·∫®n n√∫t "Chi ti·∫øt ƒë∆°n h√†ng" n·∫øu l√† kh√°ch v√£ng lai -->
										<!-- ·∫®n n√∫t "Chi ti·∫øt ƒë∆°n h√†ng" n·∫øu l√† kh√°ch v√£ng lai ho·∫∑c mua t·∫°i qu·∫ßy -->
										<th:block
											th:if="${donHang.nguoiDung.tenNguoiDung != 'Kh√°ch v√£ng lai' and donHang.diaChiGiaoHang != 'Mua t·∫°i qu·∫ßy KN'}">
											<a th:href="@{/admin/orders/{maDonHang}/confirm-status(maDonHang=${donHang.maDonHang})}"
												class="btn btn-info">
												üìã Chi ti·∫øt ƒë∆°n h√†ng
											</a>
										</th:block>





									</div>
								</div>
							</div>
							<div class="card shadow-sm">
								<div class="card-body">
									<!-- Danh s√°ch s·∫£n ph·∫©m -->
									<h5 class="mt-4">Danh S√°ch S·∫£n Ph·∫©m Trong ƒê∆°n H√†ng</h5>
									<table class="table table-bordered table-hover mt-4">
										<thead class="thead-dark">
											<tr>
												<th style="text-align: center;">STT</th>
												<th style="text-align: center;">·∫¢nh</th>
												<th style="text-align: center;">T√™n S·∫£n Ph·∫©m</th>
												<th style="text-align: center;">S·ªë L∆∞·ª£ng</th>
												<th style="text-align: center;">S·ªë L∆∞·ª£ng Tr√™n K·ªá</th>
												<th style="text-align: center;">S·ªë L∆∞·ª£ng Trong Kho</th>
												<th style="text-align: center;">ƒê∆°n Gi√°</th>
												<th style="text-align: center;">Th√†nh Ti·ªÅn</th>
											</tr>
										</thead>
										<tbody>
											<tr th:each="chiTiet, iterStat : ${donHang.chiTietDonHangs}"
												style="text-align: center;">
												<td th:text="${iterStat.index + 1}"></td>
												<td>
													<img th:src="@{'/upload/' + ${chiTiet.sanPham.hinhAnh}}"
														style="width: 50px; height: auto;" alt="·∫¢nh s·∫£n ph·∫©m" />
												</td>
												<td th:text="${chiTiet.sanPham.tenSanPham}"></td>
												<td th:text="${chiTiet.soLuong}" class="soLuong"></td>

												<!-- Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng tr√™n k·ªá -->
												<td
													th:text="${soLuongTrenKeMap[chiTiet.sanPham.maSanPham] != null ? soLuongTrenKeMap[chiTiet.sanPham.maSanPham] : 0}">
												</td>

												<!-- Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng t·ªìn kho -->
												<td
													th:text="${soLuongTonKhoMap[chiTiet.sanPham.maSanPham] != null ? soLuongTonKhoMap[chiTiet.sanPham.maSanPham] : 0}">
												</td>

												<td
													th:text="${#numbers.formatDecimal(chiTiet.giaTaiThoiDiemDat, 0, 'COMMA', 0, 'POINT')} + ' VND'">
												</td>
												<td th:text="${#numbers.formatDecimal(chiTiet.giaTaiThoiDiemDat * chiTiet.soLuong, 0, 'COMMA', 0, 'POINT')} + ' VND'"
													class="thanhTien"></td>
											</tr>
										</tbody>
									</table>


									<!-- T·ªïng ti·ªÅn v√† ph√≠ v·∫≠n chuy·ªÉn -->
									<div class="mt-4">
										<div class="card-body">
											<p><strong>T·ªïng Ti·ªÅn (<span id="soSanPham"></span> s·∫£n ph·∫©m):</strong> <span
													id="tongTien"></span> VND</p>
											<p><strong>Ph√≠ Giao H√†ng:</strong> <span
													th:text="${formattedPhiVanChuyen}"></span> VND</p>
											<p><strong>M√£ Gi·∫£m Gi√°:</strong> <span
													th:text="${formattedMaGiamGia}"></span> VND</p>
											<h5><strong>Kh√°ch Ph·∫£i Tr·∫£:</strong> <span
													th:text="${formattedTongGiaTri}"></span> VND</h5>
										</div>
									</div>
								</div>
							</div>

							<script>
								document.addEventListener("DOMContentLoaded", function () {
									let totalAmount = 0;
									let productCount = document.querySelectorAll(".soLuong").length;
									document.querySelectorAll(".thanhTien").forEach(item => {
										totalAmount += parseInt(item.innerText.replace(/\D/g, ""));
									});
									document.getElementById("tongTien").innerText = totalAmount.toLocaleString("vi-VN");
									document.getElementById("soSanPham").innerText = productCount;

									let shippingFee = parseInt(document.querySelector("[th\:text='${formattedPhiVanChuyen}']").innerText.replace(/\D/g, ""));
									let totalPayable = totalAmount + shippingFee;
									document.getElementById("tongPhaiTra").innerText = totalPayable.toLocaleString("vi-VN");
								});
							</script>

						</div>

					</div>


				</div>
			</div>

			<!-- Footer -->
			<div th:replace="admin/fragments/footer :: footer"></div>
			<!-- End Footer -->
		</div>
	</div>

	<!-- Core JS Files -->
	<div th:replace="admin/fragments/script :: script"></div>
	<!-- End JS -->
</body>

</html>