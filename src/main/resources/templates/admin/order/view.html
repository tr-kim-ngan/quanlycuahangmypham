<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="admin/fragments/head :: head">
	<!-- Ti√™u ƒë·ªÅ n√†y s·∫Ω ƒë∆∞·ª£c truy·ªÅn v√†o fragment 'head' -->
</head>

<body>
	<div class="wrapper">
		<!-- Sidebar -->
		<div th:replace="admin/fragments/sidebar :: sidebar"></div>
		<!-- End Sidebar -->

		<div class="main-panel">
			<!-- Header -->
			<div th:replace="~{admin/fragments/header :: header}"></div>
			<!-- End Header -->

			<div class="container" style="background-color: #faeee7; padding: 20px; border-radius: 8px;">
				<div class="page-inner">
					<div class="d-flex justify-content-between align-items-center mb-4">
						<div>
							<h3 class="fw-bold mb-3">Chi Ti·∫øt ƒê∆°n H√†ng</h3>
							<h6 class="text-dark">Th√¥ng tin chi ti·∫øt cho ƒë∆°n h√†ng</h6>
						</div>
					</div>

					<!-- Th√¥ng tin ƒë∆°n h√†ng -->
					<div th:if="${error}" class="alert alert-danger" role="alert">
						<span th:text="${error}"></span>
					</div>

					<div class="row">
						<!-- Th√¥ng Tin ƒê∆°n H√†ng -->

						<div class="col-md-5 mb-4">
							<div class="card shadow-sm">
								<div class="card-header bg-dark">
									<h5 class="mb-0 text-light">Th√¥ng Tin ƒê∆°n H√†ng</h5>
								</div>
								<div class="card-body">
									<p><strong>M√£ ƒê∆°n H√†ng:</strong> <span th:text="${donHang.maDonHang}"></span></p>
									<p><strong>Kh√°ch H√†ng:</strong> <span
											th:text="${donHang.nguoiDung.tenNguoiDung}"></span></p>
									<p><strong>Ng√†y ƒê·∫∑t:</strong> <span
											th:text="${#temporals.format(donHang.ngayDat, 'dd/MM/yyyy HH:mm')}"></span>
									</p>
									<p><strong>ƒê·ªãa Ch·ªâ Giao H√†ng:</strong> <span
											th:text="${donHang.diaChiGiaoHang}"></span></p>
									<p><strong>S·ªë ƒêi·ªán Tho·∫°i Nh·∫≠n H√†ng:</strong> <span
											th:text="${donHang.sdtNhanHang}"></span></p>

									<p>
										<strong>Tr·∫°ng Th√°i:</strong>
										<span th:text="${donHang.trangThaiDonHang}" th:styleappend="${donHang.trangThaiDonHang == 'ƒê√£ h·ªßy'} ? 'color: #dc3545; font-weight: bold;' :
											(${donHang.trangThaiDonHang == 'ƒê√£ ho√†n th√†nh'} ? 'color: #28a745; font-weight: bold;' : '')">
										</span>
									</p>
									<!-- N·∫øu tr·∫°ng th√°i ƒëang ch·ªù x√°c nh·∫≠n, ch·ªâ hi·ªÉn th·ªã h√¨nh ·∫£nh do shipper g·ª≠i -->
									<!-- Ch·ªâ hi·ªÉn th·ªã h√¨nh ·∫£nh khi tr·∫°ng th√°i ƒëang ch·ªù x√°c nh·∫≠n v√† shipper ƒë√£ t·∫£i ·∫£nh -->
									<th:block
										th:if="${donHang.trangThaiChoXacNhan != null and donHang.hinhAnhGiaoHang != null}">
										<div class="text-center mt-3">
											<h5>H√¨nh ·∫£nh ch·ª©ng minh giao h√†ng c·ªßa shipper</h5>
											<img th:src="@{'/upload/' + ${donHang.hinhAnhGiaoHang}}"
												alt="H√¨nh ·∫£nh giao h√†ng"
												style="width: 150px; height: auto; border-radius: 8px; box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);">
										</div>
									</th:block>


									<!-- N·∫øu tr·∫°ng th√°i ch·ªù x√°c nh·∫≠n l√† null (admin ƒë√£ x√°c nh·∫≠n), ch·ªâ hi·ªÉn th·ªã h√¨nh ·∫£nh sau khi ch·ª©ng minh giao h√†ng -->
									<th:block
										th:if="${donHang.trangThaiChoXacNhan == null and donHang.trangThaiDonHang == 'ƒê√£ ho√†n th√†nh'}">
										<div class="text mt-3">
											<h5>H√¨nh ·∫£nh sau khi ch·ª©ng minh giao h√†ng</h5>
											<img th:src="@{'/upload/' + ${donHang.hinhAnhGiaoHang}}"
												alt="H√¨nh ·∫£nh giao h√†ng"
												style="width: 100px; height: auto; border-radius: 8px; box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);">
										</div>
									</th:block>




									<!-- N·∫øu tr·∫°ng th√°i l√† "ƒê√£ x√°c nh·∫≠n", ch·ªâ hi·ªÉn th·ªã n√∫t G√°n shipper -->
									<div
										th:if="${donHang.trangThaiDonHang == 'ƒê√£ x√°c nh·∫≠n' and donHang.shipper == null}">
										<form
											th:action="@{/admin/orders/{maDonHang}/assign-shipper(maDonHang=${donHang.maDonHang})}"
											method="post">
											<div class="form-group">
												<label for="shipper">Ch·ªçn Shipper:</label>
												<select id="shipper" name="shipperId" class="form-control" required>
													<option value="">-- Ch·ªçn Shipper --</option>
													<option th:each="shipper : ${danhSachShipper}"
														th:value="${shipper.maNguoiDung}"
														th:text="${shipper.tenNguoiDung + ' (ID: ' + shipper.maNguoiDung + ')'}">
													</option>
												</select>
											</div>
											<button type="submit" class="btn btn-primary mt-3">G√°n Shipper</button>
										</form>
									</div>

									<div
										th:if="${donHang.trangThaiDonHang == 'ƒêang chu·∫©n b·ªã h√†ng' and donHang.trangThaiChoXacNhan == null}">
										<p class="text-warning">ƒê∆°n h√†ng ƒëang chu·∫©n b·ªã, shipper s·∫Ω c·∫≠p nh·∫≠t tr·∫°ng th√°i.
										</p>
									</div>


									<!-- N·∫øu tr·∫°ng th√°i l√† "ƒêang giao h√†ng" ho·∫∑c "ƒê√£ ho√†n th√†nh" v√† CH∆ØA ƒê∆Ø·ª¢C admin x√°c nh·∫≠n, hi·ªÉn th·ªã n√∫t x√°c nh·∫≠n -->
									<div
										th:if="${donHang.trangThaiChoXacNhan == 'ƒêang giao h√†ng' or donHang.trangThaiChoXacNhan == 'ƒê√£ ho√†n th√†nh'}">
										<p class="text-warning">
											Tr·∫°ng th√°i ch·ªù x√°c nh·∫≠n t·ª´ shipper:
											<strong th:text="${donHang.trangThaiChoXacNhan}"></strong>
										</p>

										<form
											th:action="@{/admin/orders/{maDonHang}/confirm-status(maDonHang=${donHang.maDonHang})}"
											method="post" class="mt-3">
											<button type="submit" class="btn btn-success">X√°c nh·∫≠n tr·∫°ng th√°i t·ª´
												shipper</button>
										</form>
									</div>




									<!-- N·∫øu tr·∫°ng th√°i ch∆∞a ph·∫£i "ƒêang giao h√†ng" ho·∫∑c "ƒê√£ ho√†n th√†nh" ho·∫∑c "ƒê√£ h·ªßy", admin c√≥ th·ªÉ c·∫≠p nh·∫≠t -->
									<div th:if="${donHang.trangThaiDonHang != 'ƒêang giao h√†ng' 
										and donHang.trangThaiDonHang != 'ƒê√£ ho√†n th√†nh' 
										and donHang.trangThaiDonHang != 'ƒê√£ h·ªßy' 
										and donHang.trangThaiDonHang != 'ƒêang chu·∫©n b·ªã h√†ng'
										and donHang.trangThaiDonHang != 'ƒê√£ x√°c nh·∫≠n'}">
										<form
											th:action="@{/admin/orders/{maDonHang}/update-status(maDonHang=${donHang.maDonHang})}"
											method="post">
											<div class="form-group">
												<label for="status">C·∫≠p Nh·∫≠t Tr·∫°ng Th√°i ƒê∆°n H√†ng:</label>
												<select id="status" name="status" class="form-control">
													<option th:each="status : ${nextStatuses}" th:value="${status}"
														th:text="${status}"></option>
												</select>
											</div>
											<button type="submit" class="btn btn-primary mt-3">C·∫≠p nh·∫≠t tr·∫°ng
												th√°i</button>
										</form>
									</div>
									<!-- N·∫øu ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh, hi·ªÉn th·ªã n√∫t "Xem H√≥a ƒê∆°n" -->
									<div th:if="${donHang.trangThaiDonHang == 'ƒê√£ ho√†n th√†nh'}">
										<a th:href="@{/admin/hoadon/{maDonHang}(maDonHang=${donHang.maDonHang})}"
											class="btn btn-success mt-3">
											üìú Xem H√≥a ƒê∆°n
										</a>
									</div>




								</div>
							</div>
						</div>

						<!-- T·ªïng Gi√° Tr·ªã -->
						<div class="col-md-7">
							<div class="card shadow-sm">
								<div class="card-header bg-dark">
									<h5 class="mb-0" style="color: #faeee7;">T·ªïng Gi√° Tr·ªã</h5>
								</div>
								<div class="card-body">
									<p><strong>Ph√≠ V·∫≠n Chuy·ªÉn:</strong> <span th:text="${formattedPhiVanChuyen}"></span>
										VND</p>
									<p><strong>T·ªïng Gi√° Tr·ªã ƒê∆°n H√†ng:</strong> <span
											th:text="${formattedTongGiaTri}"></span> VND</p>



								</div>
							</div>


							<div class="card shadow-sm mt-4">
								<div class="card-header bg-dark">
									<h5 class="mb-0" style="color: #faeee7;">L·ªãch S·ª≠ Tr·∫°ng Th√°i ƒê∆°n H√†ng</h5>
								</div>
								<div class="card-body">

									<div class="status-bar"
										style="display: flex; align-items: center; justify-content: space-between; position: relative; padding: 10px 0;">
										<div class="status-item" th:each="status, iterStat : ${displayedStatuses}"
											style="display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; flex: 1; ">

											<!-- Icon tr·∫°ng th√°i -->
											<div class="circle" th:text="${iterStat.index + 1}" th:classappend="${status == donHang.trangThaiChoXacNhan} ? 'pending-status' : 
                             (${iterStat.index <= currentStatusIndex} ? 'completed-status' : 'inactive-status')">
											</div>

											<!-- T√™n tr·∫°ng th√°i -->
											<span class="status-text" th:text="${status}" th:classappend="${status == donHang.trangThaiChoXacNhan} ? 'pending-text' : 
                              (${iterStat.index <= currentStatusIndex} ? 'completed-text' : 'inactive-text')">
											</span>
										</div>
									</div>


									<style>
										/* M√†u xanh cho tr·∫°ng th√°i ƒë√£ ho√†n th√†nh */
										.circle {
											width: 30px;
											height: 30px;
											border-radius: 50%;
											display: flex;
											justify-content: center;
											align-items: center;
											font-weight: bold;
											font-size: 14px;
											margin-bottom: 5px;
										}

										.status-bar {
											display: flex;
											align-items: center;
											justify-content: space-between;
											padding: 10px 0;
										}

										.status-item {
											display: flex;
											flex-direction: column;
											align-items: center;
											text-align: center;
											flex: 1;
											min-width: 100px;
										}

										.status-text {
											min-height: 40px;
											display: flex;
											align-items: center;
											justify-content: center;
											text-align: center;
											word-wrap: break-word;
											white-space: normal;
											max-width: 90px;
										}

										.completed-status {
											background-color: #28a745;
											color: white;
											font-weight: bold;
										}

										.completed-text {
											color: #28a745;
											font-weight: bold;
										}

										/* M√†u x√°m cho tr·∫°ng th√°i ch∆∞a ƒë·∫øn */
										.inactive-status {
											background-color: #e0e0e0;
											color: black;
											font-weight: normal;
										}

										.inactive-text {
											color: #6c757d;
										}

										/* M√†u v√†ng cho tr·∫°ng th√°i ch·ªù x√°c nh·∫≠n */
										.pending-status {
											background-color: #ff9800;
											color: white;
											font-weight: bold;
										}

										.pending-text {
											color: #ff9800;
											font-weight: bold;
										}
									</style>
									<script>
										document.addEventListener("DOMContentLoaded", function () {
											let confirmBtn = document.getElementById("confirmBtn");
											let pendingStatus = document.querySelector(".pending-status");
											let pendingText = document.querySelector(".pending-text");

											if (confirmBtn && pendingStatus && pendingText) {
												confirmBtn.addEventListener("click", function () {
													setTimeout(() => {
														pendingStatus.classList.remove("pending-status");
														pendingStatus.classList.add("completed-status");

														pendingText.classList.remove("pending-text");
														pendingText.classList.add("completed-text");
													}, 1000); // ƒê·ªïi m√†u sau 1 gi√¢y khi nh·∫•n
												});
											}
										});
									</script>




								</div>
							</div>

						</div>


					</div>


					<!-- Danh s√°ch s·∫£n ph·∫©m -->
					<h5 class="mt-0">Danh S√°ch S·∫£n Ph·∫©m Trong ƒê∆°n H√†ng</h5>
					<table class="table table-bordered table-hover mt-4">
						<thead class="thead-dark">
							<tr>
								<th style="text-align: center;">M√£ S·∫£n Ph·∫©m</th>
								<th style="text-align: center;">H√¨nh ·∫¢nh</th>
								<th style="text-align: center;">T√™n S·∫£n Ph·∫©m</th>
								<th style="text-align: center;">S·ªë L∆∞·ª£ng</th>
								<th style="text-align: center;">Gi√° T·∫°i Th·ªùi ƒêi·ªÉm ƒê·∫∑t</th>
								<th style="text-align: center;">Th√†nh Ti·ªÅn</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="chiTiet : ${formattedChiTietDonHang}" style="text-align: center;">
								<td th:text="${chiTiet['maSanPham']}"></td>
								<td>
									<img th:src="@{'/upload/' + ${chiTiet['hinhAnh']}}"
										style="width: 100px; height: auto;" alt="·∫¢nh s·∫£n ph·∫©m" />
								</td>
								<td th:text="${chiTiet['tenSanPham']}"></td>
								<td th:text="${chiTiet['soLuong']}"></td>
								<td th:text="${chiTiet['giaTaiThoiDiemDat']}+ ' VND'"></td>
								<td th:text="${chiTiet['thanhTien']} + ' VND'"></td>
							</tr>
						</tbody>


					</table>

					<!-- N√∫t Quay l·∫°i -->
					<div class="mt-4 d-flex justify-content-between">
						<a th:href="@{/admin/orders}" class="btn btn-secondary">Quay L·∫°i</a>
					</div>
				</div>
			</div>

			<!-- Footer -->
			<div th:replace="admin/fragments/footer :: footer"></div>
			<!-- End Footer -->
		</div>
	</div>

	<!-- Core JS Files -->
	<div th:replace="admin/fragments/script :: script"></div>
	<!-- End JS -->
</body>

</html>