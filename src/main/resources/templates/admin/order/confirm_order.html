<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head th:replace="admin/fragments/head :: head"></head>

<body>
	<div class="wrapper">
		<!-- Sidebar -->
		<div th:replace="admin/fragments/sidebar :: sidebar"></div>
		<!-- End Sidebar -->

		<div class="main-panel">
			<!-- Header -->
			<div th:replace="admin/fragments/header :: header"></div>
			<!-- End Header -->

			<div class="content" style="background-color: #faeee7;  padding-top: 30px; padding-bottom: 400px;">
				<div class="p-4">
					<div class="row p-4">
						<div class="col-md-8">
							<!-- N√∫t quay l·∫°i -->
							<a href="/admin/orders" class="btn  btn-secondary ">‚¨Ö Quay
								l·∫°i</a>
							<div class="card shadow-sm">

								<div class="card-header bg-dark text-light text-center">
									<h5>X√°c Nh·∫≠n Tr·∫°ng Th√°i ƒê∆°n H√†ng</h5>
								</div>
								<div class="card-body">







									<!-- Hi·ªÉn th·ªã tr·∫°ng th√°i ch·ªù x√°c nh·∫≠n -->
									<th:block th:if="${donHang.trangThaiChoXacNhan != null}">
										<p class=" text-center mt-3">
											üîÑ Tr·∫°ng th√°i ch·ªù x√°c nh·∫≠n t·ª´ shipper:
											<strong th:text="${donHang.trangThaiChoXacNhan}"></strong>
										</p>
									</th:block>

									<th:block th:if="${donHang != null}">
										<h5>Th√¥ng tin ƒê∆°n H√†ng</h5>
										<p><strong>M√£ ƒë∆°n h√†ng:</strong> <span th:text="${donHang.maDonHang}"></span>
										</p>
										<p><strong>Tr·∫°ng th√°i:</strong>
											<span th:text="${donHang.trangThaiDonHang}">
											</span>


										</p>

										<th:block th:if="${donHang.trangThaiDonHang == 'ƒê√£ h·ªßy'}">
											<p class="text-danger"></p>

										</th:block>
									</th:block>

									<th:block th:if="${donHang.trangThaiDonHang == 'Ch·ªù x√°c nh·∫≠n'}">
										<form
											th:action="@{/admin/orders/{maDonHang}/confirm-status(maDonHang=${donHang.maDonHang})}"
											method="post">
											<button type="submit" class="btn" style="background-color: transparent; 
               color: green; 
               border: 2px solid green; 
               border-radius: 5px;">
												X√°c nh·∫≠n ƒë√£ xu·∫•t kho
											</button>

										</form>
									</th:block>

									<th:block
										th:if="${donHang != null and donHang.ghiChu != null and not #strings.isEmpty(donHang.ghiChu)}">
										<p class="mt-2">L√Ω Do Giao H√†ng Th·∫•t B·∫°i</p>
										<div class="">
											<ul style="list-style: none; padding-left: 0;">
												<li th:each="reason, iterStat : ${#strings.arraySplit(donHang.ghiChu, 'üõë')}"
													th:style="'display: flex; align-items: center; margin-bottom: 2px;'">
													<span style=" font-size: 13px; margin-right: 1px;"></span>
													<span th:text="${reason}"></span>
												</li>
											</ul>
										</div>
									</th:block>

									<!--	<th:block
										th:if="${donHang.trangThaiDonHang == 'ƒêang x·ª≠ l√Ω' and donHang.nhanVienXuatKho == null}">
										<form
											th:action="@{/admin/orders/{maDonHang}/assign-export-staff(maDonHang=${donHang.maDonHang})}"
											method="post">
											<label for="handlingOption">Ch·ªçn c√°ch x·ª≠ l√Ω:</label>
											<select id="handlingOption" name="handlingOption" class="form-control"
												required>
												<option value="export">üè≠ Giao t·ª´ kho (c·∫ßn nh√¢n vi√™n xu·∫•t kho)</option>
												<option value="shelf">üõí L·∫•y h√†ng t·ª´ k·ªá</option>
											</select>

									
											<div id="warehouseStaffSelection" style="display: none; margin-top: 10px;">
												<label for="maNhanVienXuatKho">Ch·ªçn nh√¢n vi√™n xu·∫•t kho:</label>
												<select id="maNhanVienXuatKho" name="maNhanVienXuatKho"
													class="form-control">
													<option value="">-- Ch·ªçn nh√¢n vi√™n xu·∫•t kho --</option>
													<option th:each="nhanVien : ${danhSachNhanVienXuatKho}"
														th:value="${nhanVien.maNguoiDung}"
														th:text="${nhanVien.tenNguoiDung}">
													</option>
												</select>
											</div>

											<button type="submit" class="btn btn-warning mt-3">‚úî X√°c nh·∫≠n</button>
										</form>
									</th:block>-->

									<!--<script>
										document.addEventListener("DOMContentLoaded", function () {
											let handlingOption = document.getElementById("handlingOption");
											let warehouseStaffSelection = document.getElementById("warehouseStaffSelection");

											// ‚úÖ Ki·ªÉm tra n·∫øu ƒë√£ ch·ªçn "export" tr∆∞·ªõc ƒë√≥ th√¨ hi·ªÉn th·ªã lu√¥n
											if (handlingOption.value === "export") {
												warehouseStaffSelection.style.display = "block";
											}

											handlingOption.addEventListener("change", function () {
												if (this.value === "export") {
													warehouseStaffSelection.style.display = "block";
												} else {
													warehouseStaffSelection.style.display = "none";
												}
											});
										});
									</script>-->
									<!-- Tr·∫°ng th√°i ƒêang x·ª≠ l√Ω -> X√°c nh·∫≠n ƒë∆°n h√†ng -->
									<!-- N·∫øu ƒë∆°n h√†ng ƒëang x·ª≠ l√Ω, admin c√≥ th·ªÉ x√°c nh·∫≠n ho·∫∑c h·ªßy 
									<th:block
										th:if="${donHang.trangThaiDonHang == 'ƒêang x·ª≠ l√Ω'}">
										<form id="orderActionForm"
											th:action="@{/admin/orders/{maDonHang}/update-status(maDonHang=${donHang.maDonHang})}"
											method="post"
											onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn th·ª±c hi·ªán h√†nh ƒë·ªông n√†y kh√¥ng?');">

											<label for="orderAction">Ch·ªçn h√†nh ƒë·ªông:</label>
											<select id="orderAction" name="status" class="form-control" required>
												<option value="">-- Ch·ªçn tr·∫°ng th√°i --</option>
												<option value="confirm">X√°c nh·∫≠n ƒë∆°n h√†ng</option>
												<option value="cancel">H·ªßy ƒë∆°n h√†ng</option>
											</select>

											<button type="submit" id="confirmButton" class="btn btn-primary mt-3">
												X√°c nh·∫≠n</button>
										</form>
									</th:block>-->
									<th:block th:if="${donHang.trangThaiDonHang == 'ƒêang x·ª≠ l√Ω'}">
										<form id="orderActionForm"
											th:action="@{/admin/orders/{maDonHang}/update-status(maDonHang=${donHang.maDonHang})}"
											method="post" onsubmit="return validateCancelReason();">

											<label for="orderAction">Ch·ªçn h√†nh ƒë·ªông:</label>
											<select id="orderAction" name="status" class="form-control" required
												onchange="toggleCancelReason()">
												<option value="">-- Ch·ªçn tr·∫°ng th√°i --</option>
												<option value="confirm">X√°c nh·∫≠n ƒë∆°n h√†ng</option>
												<option value="cancel">H·ªßy ƒë∆°n h√†ng</option>
											</select>

											<!-- Dropdown ch·ªçn l√Ω do h·ªßy -->
											<div id="cancelReasonDiv" style="display: none; margin-top: 10px;">
												<label for="cancelReasonDropdown">L√Ω do h·ªßy ƒë∆°n h√†ng:</label>
												<select id="cancelReasonDropdown" class="form-control"
													 onchange="handleCancelReason()">
													<option value="">-- Ch·ªçn l√Ω do --</option>
													<option value="Kh√°ch h√†ng thay ƒë·ªïi √Ω ƒë·ªãnh">Kh√°ch h√†ng thay ƒë·ªïi √Ω
														ƒë·ªãnh</option>
													<option value="S·∫£n ph·∫©m h·∫øt h√†ng">S·∫£n ph·∫©m h·∫øt h√†ng</option>
													<option value="Kh√¥ng li√™n h·ªá ƒë∆∞·ª£c kh√°ch h√†ng">Kh√¥ng li√™n h·ªá ƒë∆∞·ª£c
														kh√°ch h√†ng</option>
													<option value="Kh√°ch h√†ng y√™u c·∫ßu h·ªßy">Kh√°ch h√†ng y√™u c·∫ßu h·ªßy
													</option>
													<option value="Kh√°c">Kh√°c (Nh·∫≠p tay)</option>
												</select>

												<!-- √î nh·∫≠p l√Ω do khi ch·ªçn 'Kh√°c' -->
												<textarea id="customCancelReason" class="form-control mt-2"
													placeholder="Nh·∫≠p l√Ω do h·ªßy ƒë∆°n..."
													style="display: none;"></textarea>
												<input type="hidden" name="cancelReason" id="finalCancelReason" />

											</div>

											<button type="submit" id="confirmButton" class="btn btn-primary mt-3">
												X√°c nh·∫≠n
											</button>
										</form>
									</th:block>

									<script>
										function toggleCancelReason() {
											let actionSelect = document.getElementById("orderAction");
											let cancelReasonDiv = document.getElementById("cancelReasonDiv");

											cancelReasonDiv.style.display = actionSelect.value === "cancel" ? "block" : "none";
										}


										function handleCancelReason() {
											let cancelReasonDropdown = document.getElementById("cancelReasonDropdown");
											let customCancelReason = document.getElementById("customCancelReason");
											let finalCancelReason = document.getElementById("finalCancelReason");

											if (cancelReasonDropdown.value === "Kh√°c") {
												customCancelReason.style.display = "block";
												finalCancelReason.value = "";
											} else {
												customCancelReason.style.display = "none";
												customCancelReason.value = "";
												finalCancelReason.value = cancelReasonDropdown.value;
											}
										}

										function validateCancelReason() {
											let actionSelect = document.getElementById("orderAction");
											let cancelReasonDropdown = document.getElementById("cancelReasonDropdown");
											let customCancelReason = document.getElementById("customCancelReason");
											let finalCancelReason = document.getElementById("finalCancelReason");

											if (actionSelect.value === "cancel") {
												if (cancelReasonDropdown.value === "") {
													alert("Vui l√≤ng ch·ªçn l√Ω do h·ªßy ƒë∆°n h√†ng!");
													return false;
												}

												if (cancelReasonDropdown.value === "Kh√°c") {
													if (customCancelReason.value.trim() === "") {
														alert("Vui l√≤ng nh·∫≠p l√Ω do h·ªßy ƒë∆°n h√†ng!");
														return false;
													} else {
														finalCancelReason.value = customCancelReason.value.trim();
													}
												}
											}

											return true;
										}

									</script>



									<!-- Tr·∫°ng th√°i ƒê√£ x√°c nh·∫≠n -> Ch·ªçn shipper -->
									<th:block
										th:if="${donHang.trangThaiDonHang == 'ƒê√£ x√°c nh·∫≠n' and donHang.shipper == null}">
										<form
											th:action="@{/admin/orders/{maDonHang}/assign-shipper(maDonHang=${donHang.maDonHang})}"
											method="post">
											<label for="shipper">Ch·ªçn Shipper:</label>
											<select id="shipper" name="shipperId" class="form-control" required>
												<option value="">-- Ch·ªçn Shipper --</option>
												<option th:each="shipper : ${danhSachShipper}"
													th:value="${shipper.maNguoiDung}" th:text="${shipper.tenNguoiDung}">
												</option>
											</select>
											<button type="submit" class="btn btn-primary mt-3">G√°n Shipper</button>
										</form>
									</th:block>
									<!-- Hi·ªÉn th·ªã h√¨nh ·∫£nh giao h√†ng n·∫øu c√≥ -->
									<th:block
										th:if="${donHang.hinhAnhGiaoHang != null and not #strings.isEmpty(donHang.hinhAnhGiaoHang)}">
										<h5 class="mt-3">H√¨nh ·∫¢nh Giao H√†ng</h5>
										<img th:src="@{'/upload/' + ${donHang.hinhAnhGiaoHang}}"
											alt="H√¨nh ·∫£nh giao h√†ng"
											style="max-width: 300px; border-radius: 8px; box-shadow: 0px 0px 5px rgba(0,0,0,0.2);">
									</th:block>


									<!-- Hi·ªÉn th·ªã l√Ω do giao th·∫•t b·∫°i n·∫øu c√≥ -->
									<!-- ‚ùå Hi·ªÉn th·ªã to√†n b·ªô l·ªãch s·ª≠ l√Ω do giao h√†ng th·∫•t b·∫°i -->
									<th:block
										th:if="${order != null and order.ghiChu != null and not #strings.isEmpty(order.ghiChu)}">
										<h5 class="mt-3 text-danger">‚ùå L√Ω Do Giao H√†ng Th·∫•t B·∫°i</h5>
										<div class="alert alert-warning">
											<ul>
												<li th:each="reason : ${#strings.arraySplit(order.ghiChu, '\n')}"
													th:text="${#strings.trim(reason)}"></li>
											</ul>
										</div>
									</th:block>






									<!-- N·∫øu shipper ƒë√£ ƒë∆∞·ª£c g√°n, hi·ªÉn th·ªã tr·∫°ng th√°i -->
									<div th:if="${donHang.shipper != null}">
										<p> <strong>ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c giao cho shipper: </strong>
											<span th:text="${donHang.shipper.tenNguoiDung}"
												class="text-success fw-bold"></span>
										</p>
										<p> <strong>S·ªë ƒëi·ªán tho·∫°i shipper:</strong>
											<span th:text="${donHang.shipper.soDienThoai}" class="text-primary"></span>
										</p>

										<!-- N·∫øu tr·∫°ng th√°i t·ª´ shipper l√† "ƒêang giao h√†ng", admin b·∫•m x√°c nh·∫≠n -->
										<th:block th:if="${donHang.trangThaiChoXacNhan == 'ƒêang giao h√†ng'}">
											<form
												th:action="@{/admin/orders/{maDonHang}/confirm-status(maDonHang=${donHang.maDonHang})}"
												method="post">
												<button type="submit" class="btn btn" style="color: green;">
													‚úÖ X√°c nh·∫≠n tr·∫°ng th√°i "ƒêang giao h√†ng"
												</button>
											</form>
										</th:block>

										<!-- N·∫øu tr·∫°ng th√°i t·ª´ shipper l√† "Giao th·∫•t b·∫°i", admin c√≥ 2 l·ª±a ch·ªçn -->
										<th:block
											th:if="${donHang.trangThaiChoXacNhan != null and #strings.contains(donHang.trangThaiChoXacNhan, 'Giao h√†ng th·∫•t b·∫°i (L·∫ßn 1)')}">
											<p>üö® ƒê∆°n h√†ng giao th·∫•t b·∫°i. Admin c·∫ßn quy·∫øt ƒë·ªãnh:</p>

											<form
												th:action="@{/admin/orders/{maDonHang}/update-status(maDonHang=${donHang.maDonHang})}"
												method="post">
												<label for="adminDecision">üìå Ch·ªçn h√†nh ƒë·ªông:</label>
												<select id="adminDecision" name="status" class="form-control" required>
													<option value="">-- Ch·ªçn tr·∫°ng th√°i --</option>
													<option value="retry">üîÑ Giao l·∫°i</option>
													<option value="cancel">‚ùå H·ªßy ƒë∆°n h√†ng</option>
												</select>
												<button type="submit" id="confirmButton" class="btn mt-3"
													style="color: green;">‚úÖ
													X√°c nh·∫≠n</button>
											</form>

											<!-- N·∫øu ch·ªçn giao l·∫°i, admin ch·ªçn shipper -->
											<div id="selectShipper" style="display: none; margin-top: 10px;">
												<form
													th:action="@{/admin/orders/{maDonHang}/assign-shipper(maDonHang=${donHang.maDonHang})}"
													method="post">
													<label for="shipper">üìå Ch·ªçn Shipper:</label>
													<select id="shipper" name="shipperId" class="form-control" required>
														<option value="">-- Ch·ªçn Shipper --</option>
														<option th:each="shipper : ${danhSachShipper}"
															th:value="${shipper.maNguoiDung}"
															th:text="${shipper.tenNguoiDung + ' (ID: ' + shipper.maNguoiDung + ')'}">
														</option>
													</select>
													<button type="submit" class="btn btn-warning mt-3">üöö X√°c nh·∫≠n giao
														l·∫°i</button>
												</form>
											</div>
										</th:block>
										<th:block
											th:if="${donHang.trangThaiChoXacNhan == 'Giao h√†ng th·∫•t b·∫°i (L·∫ßn 2)'}">
											<p class="text-danger fw-bold">üö® ƒê∆°n h√†ng ƒë√£ th·∫•t b·∫°i l·∫ßn 2. Kh√¥ng th·ªÉ giao
												l·∫°i!</p>
											<form
												th:action="@{/admin/orders/{maDonHang}/update-status(maDonHang=${donHang.maDonHang})}"
												method="post">


												<button type="submit" name="status" value="cancel"
													class="btn btn-danger mt-3" ;>
													X√°c nh·∫≠n h·ªßy ƒë∆°n h√†ng
												</button>
											</form>
										</th:block>


										<script>
											document.addEventListener("DOMContentLoaded", function () {
												let adminDecision = document.getElementById("adminDecision");
												let selectShipper = document.getElementById("selectShipper");
												let confirmButton = document.getElementById("confirmButton");

												if (adminDecision) {
													adminDecision.addEventListener("change", function () {
														if (this.value === "retry") {
															selectShipper.style.display = "block"; // Hi·ªán ph·∫ßn ch·ªçn shipper
															confirmButton.style.display = "none"; // ·∫®n n√∫t X√°c nh·∫≠n
														} else {
															selectShipper.style.display = "none"; // ·∫®n ch·ªçn shipper
															confirmButton.style.display = "block"; // Hi·ªán n√∫t X√°c nh·∫≠n n·∫øu kh√¥ng ph·∫£i "Giao l·∫°i"
														}
													});
												}
											});
										</script>




										<!-- N·∫øu tr·∫°ng th√°i t·ª´ shipper l√† "Giao h√†ng th√†nh c√¥ng", admin b·∫•m x√°c nh·∫≠n -->
										<th:block th:if="${donHang.trangThaiChoXacNhan == 'ƒê√£ ho√†n th√†nh'}">
											<form
												th:action="@{/admin/orders/{maDonHang}/confirm-status(maDonHang=${donHang.maDonHang})}"
												method="post">
												<button type="submit" style="color: green;" class="btn">‚úÖ X√°c nh·∫≠n ho√†n
													th√†nh</button>
											</form>
										</th:block>
									</div>




								</div>
							</div>


						</div>
					</div>
				</div>
			</div>


			<!-- Footer 
			<div th:replace="admin/fragments/footer :: footer"></div>-->
			<!-- End Footer -->
		</div>
	</div>

	<!-- Core JS Files -->
	<div th:replace="admin/fragments/script :: script"></div>
	<!-- End JS -->
</body>

</html>