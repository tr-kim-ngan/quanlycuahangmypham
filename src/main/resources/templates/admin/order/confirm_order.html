<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head th:replace="admin/fragments/head :: head"></head>

<body>
	<div class="wrapper">
		<!-- Sidebar -->
		<div th:replace="admin/fragments/sidebar :: sidebar"></div>
		<!-- End Sidebar -->

		<div class="main-panel">
			<!-- Header -->
			<div th:replace="admin/fragments/header :: header"></div>
			<!-- End Header -->

			<div class="content" style="background-color: #faeee7;  padding-top: 30px; padding-bottom: 400px;">
				<div class="p-4">
					<div class="row p-4">
						<div class="col-md-8">
							<!-- NÃºt quay láº¡i -->
							<a href="/admin/orders" class="btn  btn-secondary ">â¬… Quay
								láº¡i</a>
							<div class="card shadow-sm">

								<div class="card-header bg-dark text-light text-center">
									<h5>XÃ¡c Nháº­n Tráº¡ng ThÃ¡i ÄÆ¡n HÃ ng</h5>
								</div>
								<div class="card-body">

									<!-- Hiá»ƒn thá»‹ tráº¡ng thÃ¡i chá» xÃ¡c nháº­n -->
									<th:block th:if="${donHang.trangThaiChoXacNhan != null}">
										<p class=" text-center mt-3">
											ğŸ”„ Tráº¡ng thÃ¡i chá» xÃ¡c nháº­n tá»« shipper:
											<strong th:text="${donHang.trangThaiChoXacNhan}"></strong>
										</p>
									</th:block>

									<th:block th:if="${donHang != null}">
										<h5>ThÃ´ng tin ÄÆ¡n HÃ ng</h5>
										<p><strong>MÃ£ Ä‘Æ¡n hÃ ng:</strong> <span th:text="${donHang.maDonHang}"></span>
										</p>
										<p><strong>Tráº¡ng thÃ¡i:</strong>
											<span th:text="${donHang.trangThaiDonHang}">
											</span>
											

										</p>

										<th:block th:if="${donHang.trangThaiDonHang == 'ÄÃ£ há»§y'}">
											<p class="text-danger">ÄÆ¡n hÃ ng nÃ y Ä‘Ã£ bá»‹ há»§y.</p>
											
										</th:block>
									</th:block>
									<th:block
										th:if="${donHang != null and donHang.ghiChu != null and not #strings.isEmpty(donHang.ghiChu)}">
										<p class="mt-2">âŒ LÃ½ Do Giao HÃ ng Tháº¥t Báº¡i</p>
										<div class="">
											<ul style="list-style: none; padding-left: 0;">
												<li th:each="reason, iterStat : ${#strings.arraySplit(donHang.ghiChu, 'ğŸ›‘')}"
													th:style="'display: flex; align-items: center; margin-bottom: 2px;'">
													<span style=" font-size: 13px; margin-right: 1px;">ğŸ›‘</span>
													<span th:text="${reason}"></span>
												</li>
											</ul>
										</div>
									</th:block>


									<!-- Tráº¡ng thÃ¡i Äang xá»­ lÃ½ -> XÃ¡c nháº­n Ä‘Æ¡n hÃ ng -->
									<!-- Náº¿u Ä‘Æ¡n hÃ ng Ä‘ang xá»­ lÃ½, admin cÃ³ thá»ƒ xÃ¡c nháº­n hoáº·c há»§y -->
									<th:block th:if="${donHang.trangThaiDonHang == 'Äang xá»­ lÃ½'}">
										<form id="orderActionForm"
											th:action="@{/admin/orders/{maDonHang}/update-status(maDonHang=${donHang.maDonHang})}"
											method="post"
											onsubmit="return confirm('Báº¡n cÃ³ cháº¯c cháº¯n thá»±c hiá»‡n hÃ nh Ä‘á»™ng nÃ y khÃ´ng?');">

											<label for="orderAction">ğŸ“Œ Chá»n hÃ nh Ä‘á»™ng:</label>
											<select id="orderAction" name="status" class="form-control" required>
												<option value="">-- Chá»n tráº¡ng thÃ¡i --</option>
												<option value="confirm">âœ… XÃ¡c nháº­n Ä‘Æ¡n hÃ ng</option>
												<option value="cancel">âŒ Há»§y Ä‘Æ¡n hÃ ng</option>
											</select>

											<button type="submit" id="confirmButton" class="btn btn-primary mt-3">âœ” Thá»±c
												hiá»‡n</button>
										</form>
									</th:block>


									<!-- Tráº¡ng thÃ¡i ÄÃ£ xÃ¡c nháº­n -> Chá»n shipper -->
									<th:block
										th:if="${donHang.trangThaiDonHang == 'ÄÃ£ xÃ¡c nháº­n' and donHang.shipper == null}">
										<form
											th:action="@{/admin/orders/{maDonHang}/assign-shipper(maDonHang=${donHang.maDonHang})}"
											method="post">
											<label for="shipper">ğŸ“Œ Chá»n Shipper:</label>
											<select id="shipper" name="shipperId" class="form-control" required>
												<option value="">-- Chá»n Shipper --</option>
												<option th:each="shipper : ${danhSachShipper}"
													th:value="${shipper.maNguoiDung}"
													th:text="${shipper.tenNguoiDung + ' (ID: ' + shipper.maNguoiDung + ')'}">
												</option>
											</select>
											<button type="submit" class="btn btn-primary mt-3">ğŸšš GÃ¡n Shipper</button>
										</form>
									</th:block>
									<!-- Hiá»ƒn thá»‹ hÃ¬nh áº£nh giao hÃ ng náº¿u cÃ³ -->
									<th:block
										th:if="${donHang.hinhAnhGiaoHang != null and not #strings.isEmpty(donHang.hinhAnhGiaoHang)}">
										<h5 class="mt-3">ğŸ“· HÃ¬nh áº¢nh Giao HÃ ng</h5>
										<img th:src="@{'/upload/' + ${donHang.hinhAnhGiaoHang}}"
											alt="HÃ¬nh áº£nh giao hÃ ng"
											style="max-width: 300px; border-radius: 8px; box-shadow: 0px 0px 5px rgba(0,0,0,0.2);">
									</th:block>


									<!-- Hiá»ƒn thá»‹ lÃ½ do giao tháº¥t báº¡i náº¿u cÃ³ -->
									<!-- âŒ Hiá»ƒn thá»‹ toÃ n bá»™ lá»‹ch sá»­ lÃ½ do giao hÃ ng tháº¥t báº¡i -->
									<th:block
										th:if="${order != null and order.ghiChu != null and not #strings.isEmpty(order.ghiChu)}">
										<h5 class="mt-3 text-danger">âŒ LÃ½ Do Giao HÃ ng Tháº¥t Báº¡i</h5>
										<div class="alert alert-warning">
											<ul>
												<li th:each="reason : ${#strings.arraySplit(order.ghiChu, '\n')}"
													th:text="${#strings.trim(reason)}"></li>
											</ul>
										</div>
									</th:block>






									<!-- Náº¿u shipper Ä‘Ã£ Ä‘Æ°á»£c gÃ¡n, hiá»ƒn thá»‹ tráº¡ng thÃ¡i -->
									<div th:if="${donHang.shipper != null}">
										<p>ğŸšš ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c giao cho shipper: <span
												th:text="${donHang.shipper.tenNguoiDung}"
												class="text-success fw-bold"></span>
										</p>
										<p>ğŸ“ Sá»‘ Ä‘iá»‡n thoáº¡i shipper:
											<span th:text="${donHang.shipper.soDienThoai}" class="text-primary"></span>
										</p>

										<!-- Náº¿u tráº¡ng thÃ¡i tá»« shipper lÃ  "Äang giao hÃ ng", admin báº¥m xÃ¡c nháº­n -->
										<th:block th:if="${donHang.trangThaiChoXacNhan == 'Äang giao hÃ ng'}">
											<form
												th:action="@{/admin/orders/{maDonHang}/confirm-status(maDonHang=${donHang.maDonHang})}"
												method="post">
												<button type="submit" class="btn btn" style="color: green;">
													âœ… XÃ¡c nháº­n tráº¡ng thÃ¡i "Äang giao hÃ ng"
												</button>
											</form>
										</th:block>

										<!-- Náº¿u tráº¡ng thÃ¡i tá»« shipper lÃ  "Giao tháº¥t báº¡i", admin cÃ³ 2 lá»±a chá»n -->
										<th:block
											th:if="${donHang.trangThaiChoXacNhan != null and #strings.contains(donHang.trangThaiChoXacNhan, 'Giao hÃ ng tháº¥t báº¡i (Láº§n 1)')}">
											<p>ğŸš¨ ÄÆ¡n hÃ ng giao tháº¥t báº¡i. Admin cáº§n quyáº¿t Ä‘á»‹nh:</p>

											<form
												th:action="@{/admin/orders/{maDonHang}/update-status(maDonHang=${donHang.maDonHang})}"
												method="post">
												<label for="adminDecision">ğŸ“Œ Chá»n hÃ nh Ä‘á»™ng:</label>
												<select id="adminDecision" name="status" class="form-control" required>
													<option value="">-- Chá»n tráº¡ng thÃ¡i --</option>
													<option value="retry">ğŸ”„ Giao láº¡i</option>
													<option value="cancel">âŒ Há»§y Ä‘Æ¡n hÃ ng</option>
												</select>
												<button type="submit" id="confirmButton" class="btn mt-3"
													style="color: green;">âœ…
													XÃ¡c nháº­n</button>
											</form>

											<!-- Náº¿u chá»n giao láº¡i, admin chá»n shipper -->
											<div id="selectShipper" style="display: none; margin-top: 10px;">
												<form
													th:action="@{/admin/orders/{maDonHang}/assign-shipper(maDonHang=${donHang.maDonHang})}"
													method="post">
													<label for="shipper">ğŸ“Œ Chá»n Shipper:</label>
													<select id="shipper" name="shipperId" class="form-control" required>
														<option value="">-- Chá»n Shipper --</option>
														<option th:each="shipper : ${danhSachShipper}"
															th:value="${shipper.maNguoiDung}"
															th:text="${shipper.tenNguoiDung + ' (ID: ' + shipper.maNguoiDung + ')'}">
														</option>
													</select>
													<button type="submit" class="btn btn-warning mt-3">ğŸšš XÃ¡c nháº­n giao
														láº¡i</button>
												</form>
											</div>
										</th:block>
										<th:block
											th:if="${donHang.trangThaiChoXacNhan == 'Giao hÃ ng tháº¥t báº¡i (Láº§n 2)'}">
											<p class="text-danger fw-bold">ğŸš¨ ÄÆ¡n hÃ ng Ä‘Ã£ tháº¥t báº¡i láº§n 2. KhÃ´ng thá»ƒ giao
												láº¡i!</p>
											<form
												th:action="@{/admin/orders/{maDonHang}/update-status(maDonHang=${donHang.maDonHang})}"
												method="post">
												<button type="submit" name="status" value="cancel"
													class="btn btn-danger mt-3" ;>
													XÃ¡c nháº­n há»§y Ä‘Æ¡n hÃ ng
												</button>
											</form>
										</th:block>


										<script>
											document.addEventListener("DOMContentLoaded", function () {
												let adminDecision = document.getElementById("adminDecision");
												let selectShipper = document.getElementById("selectShipper");
												let confirmButton = document.getElementById("confirmButton");

												if (adminDecision) {
													adminDecision.addEventListener("change", function () {
														if (this.value === "retry") {
															selectShipper.style.display = "block"; // Hiá»‡n pháº§n chá»n shipper
															confirmButton.style.display = "none"; // áº¨n nÃºt XÃ¡c nháº­n
														} else {
															selectShipper.style.display = "none"; // áº¨n chá»n shipper
															confirmButton.style.display = "block"; // Hiá»‡n nÃºt XÃ¡c nháº­n náº¿u khÃ´ng pháº£i "Giao láº¡i"
														}
													});
												}
											});
										</script>




										<!-- Náº¿u tráº¡ng thÃ¡i tá»« shipper lÃ  "Giao hÃ ng thÃ nh cÃ´ng", admin báº¥m xÃ¡c nháº­n -->
										<th:block th:if="${donHang.trangThaiChoXacNhan == 'ÄÃ£ hoÃ n thÃ nh'}">
											<form
												th:action="@{/admin/orders/{maDonHang}/confirm-status(maDonHang=${donHang.maDonHang})}"
												method="post">
												<button type="submit" style="color: green;" class="btn">âœ… XÃ¡c nháº­n hoÃ n
													thÃ nh</button>
											</form>
										</th:block>
									</div>




								</div>
							</div>


						</div>
					</div>
				</div>
			</div>


			<!-- Footer -->
			<div th:replace="admin/fragments/footer :: footer"></div>
			<!-- End Footer -->
		</div>
	</div>

	<!-- Core JS Files -->
	<div th:replace="admin/fragments/script :: script"></div>
	<!-- End JS -->
</body>

</html>