<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>Chi ti·∫øt ƒë∆°n h√†ng</title>
</head>

<body style="margin: 0; padding: 0; font-family: Arial, sans-serif; background-color: #f4f4f4;">

	<!-- Sidebar b√™n tr√°i -->
	<div th:replace="seller/fragment/sidebar :: sidebar"></div>

	<!-- N·ªôi dung ch√≠nh -->
	<div style="margin-left: 250px; padding: 30px;">
		<h2>Chi ti·∫øt ƒë∆°n h√†ng</h2>

		<!-- Th√¥ng tin ƒë∆°n h√†ng -->
		<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px 30px; margin-bottom: 20px;">
			<div><strong> M√£ ƒë∆°n h√†ng:</strong> <span th:text="${donHang.maDonHang}"></span></div>
			<div><strong> Kh√°ch h√†ng:</strong>
				<span th:text="${donHang.nguoiDung != null ? donHang.nguoiDung.tenNguoiDung : 'Kh√¥ng x√°c ƒë·ªãnh'}"></span>
			</div>
			<div><strong> ƒê·ªãa ch·ªâ giao h√†ng:</strong> <span th:text="${donHang.diaChiGiaoHang}"></span></div>
			<div><strong> Tr·∫°ng th√°i:</strong> <span th:text="${donHang.trangThaiDonHang}"></span></div>
			<div><strong>üìÖ Ng√†y ƒë·∫∑t:</strong>
				<span th:text="${#temporals.format(donHang.ngayDat, 'dd-MM-yyyy HH:mm')}"></span>
			</div>
		</div>

		<!-- Form g√°n shipper n·∫øu tr·∫°ng th√°i l√† 'ƒê√£ x√°c nh·∫≠n' 
		<div th:if="${donHang.trangThaiDonHang == 'ƒê√£ x√°c nh·∫≠n'}" style="margin-bottom: 20px;">
			<form th:action="@{/seller/orders/{id}/assign-shipper(id=${donHang.maDonHang})}" method="post"
				style="background-color: #fff; padding: 15px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); width: fit-content;">
				<label for="shipper"><strong>üöö G√°n shipper:</strong></label>
				<select name="shipperId" id="shipper" required style="margin-left: 10px; padding: 5px;">
					<option value="">-- Ch·ªçn shipper --</option>
					<option th:each="shipper : ${danhSachShipper}" th:value="${shipper.maNguoiDung}"
						th:text="${shipper.tenNguoiDung}"></option>
				</select>
				<button type="submit"
					style="margin-left: 10px; padding: 5px 10px; background-color: #1f2a40; color: white; border: none; border-radius: 3px; cursor: pointer;">X√°c
					nh·∫≠n</button>
			</form>
		</div>-->

		<!-- Form c·∫≠p nh·∫≠t tr·∫°ng th√°i n·∫øu c√≥ tr·∫°ng th√°i ti·∫øp theo -->
		<div th:if="${nextStatuses != null}" style="margin-bottom: 20px;">
			<form th:action="@{/seller/orders/update-status}" method="post"
				style="background-color: #fff; padding: 15px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.1); width: fit-content;">
				<input type="hidden" name="maDonHang" th:value="${donHang.maDonHang}" />
				<label for="trangThai"><strong>‚öôÔ∏è Ch·ªçn tr·∫°ng th√°i ti·∫øp theo:</strong></label>
				<select name="trangThai" id="trangThai" required style="margin-left: 10px; padding: 5px;">
					<option th:each="status : ${nextStatuses}" th:value="${status}" th:text="${status}"></option>
				</select>
				<button type="submit"
					style="margin-left: 10px; padding: 5px 10px; background-color: #1f2a40; color: white; border: none; border-radius: 3px; cursor: pointer;">X√°c
					nh·∫≠n tr·∫°ng th√°i</button>
			</form>
		</div>

		<!-- B·∫£ng s·∫£n ph·∫©m -->
		<table border="1" cellspacing="0" cellpadding="10"
			style="width: 100%; margin-top: 20px; background-color: white;">
			<thead style="background-color: #1f2a40; color: white;">
				<tr>
					<th>STT</th>
					<th>H√¨nh ·∫£nh</th>
					<th>T√™n s·∫£n ph·∫©m</th>
					<th>S·ªë l∆∞·ª£ng</th>
					<th>ƒê∆°n gi√°</th>
					<th>Th√†nh ti·ªÅn</th>
				</tr>
			</thead>
			<tbody>
				<tr th:each="chiTiet, iterStat : ${donHang.chiTietDonHangs}">
					<td th:text="${iterStat.count}"></td>
					<td><img th:src="@{'/upload/' + ${chiTiet.sanPham.hinhAnh}}" alt="·∫£nh"
							style="width: 60px; height: 60px;"></td>
					<td th:text="${chiTiet.sanPham.tenSanPham}"></td>
					<td th:text="${chiTiet.soLuong}"></td>
					<td th:text="${#numbers.formatDecimal(chiTiet.giaTaiThoiDiemDat, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">
					</td>
					<td class="thanhTien"
						th:text="${#numbers.formatDecimal(chiTiet.soLuong * chiTiet.giaTaiThoiDiemDat, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'">
					</td>

				</tr>
				<tr th:if="${donHang.chiTietDonHangs.size() == 0}">
					<td colspan="6" style="text-align: center;">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o trong ƒë∆°n h√†ng.</td>
				</tr>
			</tbody>
		</table>

		<!-- T·ªïng ti·ªÅn -->
		<!-- T·ªïng ti·ªÅn v√† ph√≠ v·∫≠n chuy·ªÉn -->
		<div class="mt-4">
			<div class="card-body">
				<p><strong>T·ªïng Ti·ªÅn (<span id="soSanPham"></span> s·∫£n ph·∫©m):</strong>
					<span id="tongTien"></span> VND
				</p>
				<p><strong>Ph√≠ Giao H√†ng:</strong>
					<span th:text="${#numbers.formatDecimal(donHang.phiVanChuyen, 0, 'COMMA', 0, 'POINT')}"></span> VND
				</p>
				<p><strong>M√£ Gi·∫£m Gi√°:</strong> 0 VND</p>
				<!-- N·∫øu ƒë∆°n h√†ng ƒë√£ thanh to√°n -->
				<div th:if="${donHang.tongGiaTriDonHang == 0}">
					<h5 style="color: green;">
						<strong>ƒê∆°n h√†ng ƒë√£ thanh to√°n</strong>
					</h5>
				</div>
				<h4><strong>Kh√°ch Ph·∫£i Tr·∫£:</strong>
					<span th:text="${#numbers.formatDecimal(donHang.tongGiaTriDonHang, 0, 'COMMA', 0, 'POINT')}"></span>
					VND
					</h3>
			</div>
		</div>

		<script>
			document.addEventListener("DOMContentLoaded", function () {
				let totalAmount = 0;
				let productCount = 0;

				// T√≠nh t·ªïng th√†nh ti·ªÅn v√† s·ªë s·∫£n ph·∫©m
				document.querySelectorAll("tbody tr").forEach(row => {
					const thanhTienEl = row.querySelector(".thanhTien");

					if (thanhTienEl) {
						const value = parseInt(thanhTienEl.innerText.replace(/[^\d]/g, ""));
						if (!isNaN(value)) {
							totalAmount += value;
							productCount++;
						}
					}
				});

				// G√°n v√†o HTML
				document.getElementById("tongTien").innerText = totalAmount.toLocaleString("vi-VN");
				document.getElementById("soSanPham").innerText = productCount;
			});
		</script>


		<!-- N·∫øu c√≥ tr·∫°ng th√°i ch·ªù x√°c nh·∫≠n -->
		<!-- B·ªçc chung to√†n kh·ªëi -->
		<div style="display: flex; gap: 40px; margin-top: 30px; align-items: flex-start;">

			<!-- B√äN TR√ÅI: Th√¥ng tin giao h√†ng -->
			<div style="flex: 1;">
				<!-- H√¨nh ·∫£nh giao h√†ng -->
				<div th:if="${!#strings.isEmpty(donHang.hinhAnhGiaoHang)}">
					<h4 style="color: #1f2a40;">üì∑ H√¨nh ·∫£nh giao h√†ng:</h4>
					<img th:src="@{'/upload/' + ${donHang.hinhAnhGiaoHang}}" alt="H√¨nh ·∫£nh giao h√†ng"
						style="max-width: 250px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.2);">
				</div>

				<!-- Shipper -->
				<div th:if="${donHang.shipper != null}" style="margin-top: 20px;">
					<p>ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c giao cho: <span th:text="${donHang.shipper.tenNguoiDung}"
							style="color: green;"></span></p>
					<p>ƒêi·ªán tho·∫°i: <span th:text="${donHang.shipper.soDienThoai}" style="color: #007bff;"></span></p>
				</div>

				<!-- Ghi ch√∫ -->
				<div th:if="${donHang.ghiChu != null and !#strings.isEmpty(donHang.ghiChu)}" style="margin-top: 20px;">
					<h4 style="color: #dc3545;">L√Ω do th·∫•t b·∫°i:</h4>
					<div style="background-color: #f8f9fa; border-radius: 5px;">
						<span th:utext="${#strings.replace(donHang.ghiChu, '\n', '<br/>')}"></span>
					</div>
				</div>

			</div>

			<!-- B√äN PH·∫¢I: X·ª≠ l√Ω tr·∫°ng th√°i -->
			<div style="flex: 1; background-color: #f4f4f4; padding: 20px; border-radius: 8px; ">

				<th:block th:if="${donHang.trangThaiDonHang == 'ƒêang x·ª≠ l√Ω'}">
					<form id="orderActionForm"
						th:action="@{/seller/orders/{maDonHang}/update-status(maDonHang=${donHang.maDonHang})}"
						method="post" onsubmit="return validateCancelReason();">

						<label for="orderAction">Ch·ªçn h√†nh ƒë·ªông:</label>
						<select id="orderAction" name="status" class="form-control" required
							onchange="toggleCancelReason()" style="font-size:16px;padding:10px;">
							<option value="">-- Ch·ªçn tr·∫°ng th√°i --</option>
							<option value="confirm">X√°c nh·∫≠n ƒë∆°n h√†ng</option>
							<option value="cancel">H·ªßy ƒë∆°n h√†ng</option>
						</select>

						<!-- Dropdown ch·ªçn l√Ω do h·ªßy -->
						<div id="cancelReasonDiv" style="display: none; margin-top: 10px;">
							<label for="cancelReasonDropdown">L√Ω do h·ªßy ƒë∆°n h√†ng:</label>
							<select id="cancelReasonDropdown" class="form-control" onchange="handleCancelReason()"
								style="font-size:16px;padding:10px;">
								<option value="">-- Ch·ªçn l√Ω do --</option>
								<option value="Kh√°ch h√†ng thay ƒë·ªïi √Ω ƒë·ªãnh">Kh√°ch h√†ng thay ƒë·ªïi √Ω ƒë·ªãnh</option>
								<option value="S·∫£n ph·∫©m h·∫øt h√†ng">S·∫£n ph·∫©m h·∫øt h√†ng</option>
								<option value="Kh√¥ng li√™n h·ªá ƒë∆∞·ª£c kh√°ch h√†ng">Kh√¥ng li√™n h·ªá ƒë∆∞·ª£c kh√°ch h√†ng</option>
								<option value="Kh√°ch h√†ng y√™u c·∫ßu h·ªßy">Kh√°ch h√†ng y√™u c·∫ßu h·ªßy</option>
								<option value="Kh√°c">Kh√°c (Nh·∫≠p tay)</option>
							</select>

							<!-- √î nh·∫≠p l√Ω do khi ch·ªçn 'Kh√°c' -->
							<textarea id="customCancelReason" class="form-control mt-2"
								placeholder="Nh·∫≠p l√Ω do h·ªßy ƒë∆°n..."
								style="display:none;font-size:16px;padding:10px;"></textarea>
							<input type="hidden" name="cancelReason" id="finalCancelReason" />

						</div>

						<button type="submit" id="confirmButton" class="btn btn-primary mt-3"
							style="font-size:16px;padding:10px 20px;">
							‚úÖ X√°c nh·∫≠n
						</button>
					</form>
				</th:block>

				<!-- JavaScript x·ª≠ l√Ω l√Ω do h·ªßy ƒë∆°n h√†ng -->
				<script>
					function toggleCancelReason() {
						let actionSelect = document.getElementById("orderAction");
						let cancelReasonDiv = document.getElementById("cancelReasonDiv");

						cancelReasonDiv.style.display = actionSelect.value === "cancel" ? "block" : "none";
					}

					function handleCancelReason() {
						let cancelReasonDropdown = document.getElementById("cancelReasonDropdown");
						let customCancelReason = document.getElementById("customCancelReason");
						let finalCancelReason = document.getElementById("finalCancelReason");

						if (cancelReasonDropdown.value === "Kh√°c") {
							customCancelReason.style.display = "block";
							finalCancelReason.value = ""; // reset gi√° tr·ªã
						} else {
							customCancelReason.style.display = "none";
							customCancelReason.value = "";
							finalCancelReason.value = cancelReasonDropdown.value;
						}
					}

					function validateCancelReason() {
						let actionSelect = document.getElementById("orderAction");
						let cancelReasonDropdown = document.getElementById("cancelReasonDropdown");
						let customCancelReason = document.getElementById("customCancelReason");
						let finalCancelReason = document.getElementById("finalCancelReason");

						if (actionSelect.value === "cancel") {
							if (cancelReasonDropdown.value === "") {
								alert("Vui l√≤ng ch·ªçn l√Ω do h·ªßy ƒë∆°n h√†ng!");
								return false;
							}

							if (cancelReasonDropdown.value === "Kh√°c") {
								if (customCancelReason.value.trim() === "") {
									alert("Vui l√≤ng nh·∫≠p l√Ω do h·ªßy ƒë∆°n h√†ng!");
									return false;
								} else {
									finalCancelReason.value = customCancelReason.value.trim();
								}
							}
						}

						return true;
					}

				</script>

				<!-- G√°n shipper n·∫øu ƒë∆°n ƒë√£ x√°c nh·∫≠n (hi·ªÉn th·ªã sau c√πng trong kh·ªëi) -->
				<div th:if="${donHang.trangThaiDonHang == 'ƒê√£ x√°c nh·∫≠n'}">
					<form th:action="@{/seller/orders/{id}/assign-shipper(id=${donHang.maDonHang})}" method="post"
						style="  border-radius: 5px;  width: fit-content;">
						<label style="font-weight: bold; font-size: 18px; display: block; margin-bottom: 10px;"
							for="shipper"><strong>üöö G√°n shipper:</strong></label>
						<select name="shipperId" id="shipper" required style="margin-left: 10px; padding: 10px;">
							<option style="font-size: 16px;" value="">-- Ch·ªçn shipper --</option>
							<option style="font-size: 16px;" th:each="shipper : ${danhSachShipper}"
								th:value="${shipper.maNguoiDung}" th:text="${shipper.tenNguoiDung}"></option>
						</select>
						<button type="submit" style="font-size: 16px; padding: 10px 20px; color: green;">
							X√°c nh·∫≠n</button>
					</form>
				</div>

				<!-- Tr·∫°ng th√°i ch·ªù x√°c nh·∫≠n -->
				<div style="margin-top: 20px;" th:if="${donHang.trangThaiChoXacNhan == 'ƒêang giao h√†ng' 
             or donHang.trangThaiChoXacNhan == 'Giao l·∫°i ƒë∆°n h√†ng'
             or donHang.trangThaiChoXacNhan == 'ƒê√£ ho√†n th√†nh'}">
					<p style="font-size: 18px; color: #1f2a40;"><strong>üîÑ ƒêang ch·ªù x√°c nh·∫≠n:</strong> <span
							th:text="${donHang.trangThaiChoXacNhan}"></span></p>
					<form th:action="@{/seller/orders/{maDonHang}/confirm-status(maDonHang=${donHang.maDonHang})}"
						method="post">
						<button style="font-size: 16px; padding: 10px 20px; color: green;" type="submit"
							class="btn btn-success mt-2">X√°c nh·∫≠n tr·∫°ng th√°i</button>
					</form>
				</div>

				<!-- Giao h√†ng th·∫•t b·∫°i l·∫ßn 1 -->
				<div th:if="${donHang.trangThaiChoXacNhan != null and #strings.contains(donHang.trangThaiChoXacNhan, 'Giao h√†ng th·∫•t b·∫°i (L·∫ßn 1)')}"
					style="margin-top: 20px;">
					<p class="text-danger fw-bold">üö® Giao h√†ng th·∫•t b·∫°i l·∫ßn 1. Ch·ªçn h√†nh ƒë·ªông ti·∫øp theo:</p>
					<form th:action="@{/seller/orders/{maDonHang}/update-status(maDonHang=${donHang.maDonHang})}"
						method="post">
						<label for="adminDecision" style="font-size: 18px;">üìå H√†nh ƒë·ªông:</label>
						<select style="font-size: 16px; padding: 10px;" id="adminDecision" name="status"
							class="form-control" required>
							<option value="">-- Ch·ªçn tr·∫°ng th√°i --</option>
							<option value="retry">Giao l·∫°i</option>
							<option value="cancel">H·ªßy ƒë∆°n h√†ng</option>
						</select>
						<button style="font-size: 16px; padding: 10px" type="submit" id="confirmButton"
							class="btn btn-primary mt-3">‚úÖ X√°c nh·∫≠n</button>
					</form>

					<!-- N·∫øu ch·ªçn giao l·∫°i th√¨ ch·ªçn shipper -->
					<div id="selectShipper" style="display: none; margin-top: 20px;">
						<form th:action="@{/seller/orders/{maDonHang}/assign-shipper(maDonHang=${donHang.maDonHang})}"
							method="post">
							<label style="font-size: 18px;" for="shipper">üöö Ch·ªçn shipper:</label>
							<select style="font-size: 16px; padding: 10px;" id="shipper" name="shipperId"
								class="form-control" required>
								<option value="">-- Ch·ªçn Shipper --</option>
								<option th:each="shipper : ${danhSachShipper}" th:value="${shipper.maNguoiDung}"
									th:text="${shipper.tenNguoiDung}"></option>
							</select>
							<button style="font-size: 16px; padding: 10px 20px;" type="submit"
								class="btn btn-warning mt-2">üì¶ X√°c nh·∫≠n giao l·∫°i</button>
						</form>
					</div>
				</div>

				<!-- Giao th·∫•t b·∫°i l·∫ßn 2 -->
				<div th:if="${donHang.trangThaiChoXacNhan == 'Giao h√†ng th·∫•t b·∫°i (L·∫ßn 2)'}" class="mt-4">
					<p class="text-danger fw-bold">üö´ Giao h√†ng th·∫•t b·∫°i l·∫ßn 2. Kh√¥ng th·ªÉ giao l·∫°i!</p>
					<form th:action="@{/seller/orders/{maDonHang}/update-status(maDonHang=${donHang.maDonHang})}"
						method="post">
						<button style=" font-size:  16px; padding: 10px ; color: #dc3545;" type="submit" name="status"
							value="cancel" class="btn btn-danger"> X√°c nh·∫≠n h·ªßy ƒë∆°n
							h√†ng</button>
					</form>
				</div>

			</div>
		</div>

		<script>
			document.addEventListener("DOMContentLoaded", function () {
				let adminDecision = document.getElementById("adminDecision");
				let selectShipper = document.getElementById("selectShipper");
				let confirmButton = document.getElementById("confirmButton");

				if (adminDecision) {
					adminDecision.addEventListener("change", function () {
						if (this.value === "retry") {
							selectShipper.style.display = "block";
							confirmButton.style.display = "none";

							setTimeout(() => {
								const select = document.getElementById("shipper");
								select.focus();
							}, 100);
						} else {
							selectShipper.style.display = "none";
							confirmButton.style.display = "block";
						}
					});
				}
			});
		</script>

</body>


</html>