<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{shipper/fragments/head::head}">
	<title>Chi tiết đơn hàng</title>
</head>

<body>
	<div class="wrapper">
		<div class="sidebar" th:replace="~{shipper/fragments/sidebar::sidebar}"></div>
		<div class="main-panel">
			<div th:replace="~{shipper/fragments/header::header}"></div>

			<div class="container mt-4"
				style="padding-left:190px; padding-right:0; margin-right: 0px; margin-left: 100px;">
				<div class="p-4"
					style="background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);">
					<h3 class="text-center text-primary">Chi tiết đơn hàng</h3>
					<hr>
					<div class="row">
						<div class="col-md-6" style="padding-left:100px;">
							<p><strong>Mã đơn hàng:</strong> <span th:text="${order.maDonHang}"></span></p>
							<p th:if="${order.nguoiDung != null}"><strong>Người đặt hàng:</strong> <span
									th:text="${order.nguoiDung.tenNguoiDung}"></span></p>
							<p th:if="${order.nguoiDung == null}" class="text-danger"><strong>Người đặt hàng:</strong>
								Không có thông tin</p>
							<p><strong>Số điện thoại nhận hàng:</strong> <span th:text="${order.sdtNhanHang}"></span>
							</p>
							<p><strong>Ngày đặt:</strong> <span
									th:text="${#temporals.format(order.ngayDat, 'dd/MM/yyyy HH:mm')}"></span></p>
						</div>
						<div class="col-md-6">
							<p><strong>Địa chỉ giao hàng:</strong> <span th:text="${order.diaChiGiaoHang}"></span></p>
							<p><strong>Trạng thái:</strong> <span class="badge bg-info"
									th:text="${order.trangThaiDonHang}"></span></p>
							<p><strong>Ghi chú:</strong> <span th:text="${order.ghiChu}"></span></p>
							<p><strong>Phí vận chuyển:</strong> <span
									th:text="${#numbers.formatDecimal(order.phiVanChuyen, 0, 'COMMA', 0, 'POINT')} + ' đ'"></span>
							</p>
							<p><strong>Tổng giá trị đơn hàng:</strong> <span class="text-danger fw-bold"
									th:text="${#numbers.formatDecimal(order.tongGiaTriDonHang, 0, 'COMMA', 0, 'POINT')} + ' đ'"></span>
							</p>
						</div>
					</div>

					<p th:if="${order.trangThaiChoXacNhan != null}" class="text-warning" style="padding-left:100px;">
						<strong>Trạng thái chờ xác nhận:</strong> <span th:text="${order.trangThaiChoXacNhan}"></span>
					</p>

					<hr>
					<h5 class="mt-3" style="padding-left:100px;">Danh sách sản phẩm</h5>
					<ul class="p-0" th:each="item : ${order.chiTietDonHangs}" style="list-style: none;">
						<li class="py-2 d-flex align-items-center justify-content-between" style="padding-left:100px;">
							<!-- Thông tin sản phẩm bên trái -->
							<div class="col-md-6">

								<strong
									th:text="${item.sanPham != null ? item.sanPham.tenSanPham : 'Không có dữ liệu'}"></strong>
								<p>Số lượng: <span th:text="${item.soLuong}"></span></p>
								<p>Giá: <span
										th:text="${#numbers.formatDecimal(item.giaTaiThoiDiemDat, 0, 'COMMA', 2, 'POINT')} + ' đ'"></span>
								</p>
							</div>

							<!-- Hình ảnh sản phẩm bên phải -->
							<div class="col-md-6">
								<img th:src="@{'/upload/' + ${item.sanPham.hinhAnh}}" alt="Hình ảnh sản phẩm"
									style="width: 90px; height: 90px; object-fit: cover; border-radius: 8px; box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);">

							</div>
						</li>
					</ul>


					<hr>

					<!-- Hiển thị hình ảnh giao hàng nếu có -->
					<div th:if="${order.hinhAnhGiaoHang != null}" style=" padding-left:100px;">
						<h5>Hình ảnh chứng minh giao hàng</h5>
						<img th:src="@{'/upload/' + ${order.hinhAnhGiaoHang}}" alt="Hình ảnh giao hàng"
							style="max-width: 100px; height: auto; border-radius: 8px; box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);">
					</div>

					<!-- Hiển thị form cập nhật trạng thái nếu chưa có trạng thái chờ xác nhận và chưa được admin xác nhận -->
					<th:block
						th:if="${order.trangThaiChoXacNhan == null && order.trangThaiDonHang != 'Đã hoàn thành' && order.trangThaiDonHang != 'Giao thất bại'}">

						<h5 class="mt-3" style="padding-left:100px;">Cập nhật trạng thái đơn hàng</h5>
						<form th:action="@{/shipper/order/update-status}" method="post" style="padding-left:100px;"
							enctype="multipart/form-data">
							<input type="hidden" name="orderId" th:value="${order.maDonHang}">

							<!-- Nếu trạng thái là 'Đang chuẩn bị hàng' thì không cần dropdown, chỉ cần gửi thẳng 'Đang giao hàng' -->
							<input type="hidden" name="status" th:value="'Đang giao hàng'"
								th:if="${order.trangThaiDonHang == 'Đang chuẩn bị hàng'}">

							<!-- Nếu trạng thái là 'Đang giao hàng' thì hiển thị dropdown -->
							<th:block th:if="${order.trangThaiDonHang == 'Đang giao hàng'}">
								<label for="status">Trạng thái:</label>
								<select name="status" id="status" class="form-select">
									<option value="Đã hoàn thành">Đã hoàn thành</option>
									<option value="Giao thất bại">Giao thất bại</option>
								</select>
								<label for="hinhAnh">Hình ảnh chứng minh giao hàng (tối đa 2MB):</label>
								<input type="file" name="hinhAnh" id="hinhAnh" class="form-control" accept="image/*"
									required>
								<p id="error-message" style="color: red; display: none;">❌ File quá lớn! Vui lòng chọn
									file dưới 2MB.</p>




							</th:block>
							<button type="submit" class="btn btn-primary mt-3">
								<span th:if="${order.trangThaiDonHang == 'Đang chuẩn bị hàng'}">Xác nhận giao
									hàng</span>
								<span th:if="${order.trangThaiDonHang == 'Đang giao hàng'}">Gửi cập nhật</span>
							</button>
						</form>
						<script>
							document.addEventListener("DOMContentLoaded", function () {
								const fileInput = document.getElementById("hinhAnh");
								const errorMessage = document.getElementById("error-message");
								const submitBtn = document.getElementById("submit-btn");

								if (fileInput) {
									fileInput.addEventListener("change", function () {
										if (this.files[0] && this.files[0].size > 2 * 1024 * 1024) { // 2MB
											errorMessage.style.display = "block";
											submitBtn.disabled = true;
										} else {
											errorMessage.style.display = "none";
											submitBtn.disabled = false;
										}
									});
								}
							});
						</script>
					</th:block>
				</div>
			</div>
		</div>
	</div>
</body>

</html>